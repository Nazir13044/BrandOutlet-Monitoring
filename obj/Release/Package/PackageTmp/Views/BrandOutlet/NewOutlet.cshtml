
@{
    ViewBag.Title = "NewOutlet";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<style>
    .ui-autocomplete {
        max-height: 200px;
        overflow-y: auto;
        /* prevent horizontal scrollbar */
        overflow-x: hidden;
        /* add padding to account for vertical scrollbar */
        padding-right: 20px;
    }

    #tblAddedItems thead tr {
        background-color: darkslategray;
        color: whitesmoke;
        font-weight: bold;
    }

    #tblAddedItems tbody tr {
        color: #2F4F4F;
        font-weight: bold;
    }
</style>
<div class="row">
    <div class="col-md-7 col-xs-7">
        <div class="x_panel">
            <div class="x_title">
                <h2>Brand Outlet Monitoring Sub Category</h2>
                <ul class="nav navbar-right panel_toolbox">
                    <li>
                        <a class="collapse-link"><i class="fa fa-chevron-up"></i></a>
                    </li>
                    <li class="dropdown">

                    </li>
                    <li>
                        <a class="close-link"><i class="fa fa-close"></i></a>
                    </li>
                </ul>
                <div class="clearfix"></div>
            </div>
            <div class="x_content">
                <br />
                <div class="form-horizontal form-label-left input_mask">



                    <div class="form-group row">
                        <label class="col-sm-3 form-control-label">Retailer Name</label>
                        <div class="col-sm-7" id="">
                            <input id="txtRetailerName" type="text" maxlength="100" placeholder="Type Name" required="" class="form-control form-control-success">

                        </div>

                    </div>

                    <div class="form-group row">
                        <label class="col-sm-3 form-control-label">Retailer Address</label>
                        <div class="col-sm-7" id="">
                            <input id="txtRetailerAddress" type="text" maxlength="100" placeholder="Type Address" required="" class="form-control form-control-success">


                        </div>
                    </div>
                    <div class="form-group row">
                        <label class="col-sm-3 form-control-label">Retailer Phone</label>
                        <div class="col-sm-7" id="">
                            <input id="txtRetailerPhone" type="text" maxlength="100" placeholder="Type Address" required="" class="form-control form-control-success">


                        </div>
                    </div>

                    <div class="form-group row">
                        <label class="col-sm-3 form-control-label">Brand Category</label>
                        <div class="col-sm-7" id="">
                            <input id="txtBrandCategory" type="text" maxlength="100" placeholder="Type Category" required="" class="form-control form-control-success">


                        </div>

                    </div>

                    <div class="ln_solid"></div>
                    <div class="form-group">
                        <div class="col-md-9 col-sm-9 col-xs-12 col-md-offset-3 pull-right">
                           
                            <input type="button" id="btnAdd" value="Add" class="btn btn-primary">
                        </div>
                    </div>




                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-5 col-xs-5">
        <div class="x_panel">
            <div class="x_title">
                <h2>Brand Outlet Monitoring Sub Category</h2>
                <ul class="nav navbar-right panel_toolbox">
                    <li>
                        <a class="collapse-link"><i class="fa fa-chevron-up"></i></a>
                    </li>
                    <li class="dropdown">

                    </li>
                    <li>
                        <a class="close-link"><i class="fa fa-close"></i></a>
                    </li>
                </ul>
                <div class="clearfix"></div>
            </div>
            <div class="x_content" id="divSubCategory">
                
                

            </div>
        </div>
    </div>
    
    <div class="col-md-12 col-xs-12">
        <div class="x_panel" id="divAddedItems" style="display: none;">
            <div class="x_title">
                <h2>Added Data</h2>
                <ul class="nav navbar-right panel_toolbox">
                    <li>
                        <a class="collapse-link"><i class="fa fa-chevron-up"></i></a>
                    </li>
                    <li class="dropdown">

                    </li>
                    <li>
                        <a class="close-link"><i class="fa fa-close"></i></a>
                    </li>
                </ul>
                <div class="clearfix"></div>
            </div>
            <div class="x_content" id="divSubCategory">

                
                <table class="table table-bordered table-hover" id="tblAddedItems">
                    <thead>
                        <tr>
                            <th style="">
                                Category Id
                            </th>
                            <th>
                                Category Name
                            </th>
                            <th>
                                Sub Category Id
                            </th>
                            <th>
                                Sub Category Name
                            </th>
                            <th>
                                Quantity
                            </th>
                            <th>Action</th>
                            
                        </tr>
                    </thead>
                    <tbody class="tbody"></tbody>
                </table>
                <div class="form-group pull-right">
                    <div class="col-md-9 col-sm-9 col-xs-12 col-md-offset-3">

                        <input type="button" id="btnSave" value="Save" class="btn btn-success">
                    </div>
                </div>


            </div>
        </div>
    </div>
    

</div>
<input type="hidden" name="hdretailerId" id="hdretailerId" />
<input type="hidden" name="hdbrandId" id="hdbrandId" />

<link href="~/Plugins/vendors/JqueryChoosen/chosen-bootstrap.css" rel="stylesheet" />
<link href="~/Plugins/vendors/JqueryChoosen/chosen.css" rel="stylesheet" />
<link href="~/Plugins/vendors/izitoast/iziToast.min.css" rel="stylesheet" />
<link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">

<script src="~/Plugins/vendors/jquery/dist/jquery-1.9.1.min.js"></script>
<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
<script src="~/Plugins/vendors/chosen.jquery.js"></script>
<script src="~/Plugins/vendors/izitoast/iziToast.min.js"></script>

<script>
    $('#txtRetailerName').autocomplete({
        source: "@Url.Action("GetRetailers", "BrandOutlet")",
        minLength: 3,
    select: function (event, ui) {
        
        $("#txtRetailerAddress").val(ui.item.Address);
        $("#txtRetailerPhone").val(ui.item.Phone);
        $("#hdretailerId").val(ui.item.Id);
        

    }
    });
    

    $('#txtBrandCategory').autocomplete({
        source: "@Url.Action("GetBrandCategoryDetails", "BrandOutlet")",
        minLength: 3,
    select: function (event, ui) {
        
        $("#hdbrandId").val(ui.item.Id);

        GetBrandSubCategories(ui.item.Id);
    }
    });

    function GetBrandSubCategories(id) {
        
        $.ajax({
            url: '  @Url.Action("GetBrandSubCategory", "BrandOutlet")',
            type: 'GET',
            data:{id:id},
            dataType: 'json',
            async: false,
            contentType: 'application/json',
            success: function (data) {
                if (data.length == 0) {
                    $('#divSubCategory').empty();
                    $('#divSubCategory').append('<div class="statistic d-flex align-items-center bg-white has-shadow" ><div class="icon bg-green"><i class="fa fa-calendar-o"></i></div><div class="text"><small>No data available</small></div></div>');

                    return false;
                } else {

                    $('#divSubCategory').empty();
                    $.each(data, function (index, itemData) {

                        $("#divSubCategory").append('<div class="col-md-6" style="font-size:12px;><form><div class="form-check"><label><input type="checkbox" style="font-size:12px;"  name="subcategory" value="' + itemData.Id + '"> <span class="label-text">' + itemData.Name + '</span></label></div></form> </div>');
                    });

                }

            },
            error: function (result, textStatus, jqXHR) {
                //toastr.error(result.Message);
                // alert("Error");
                return false;
            }
        });

    }
    $("#btnAdd").click(function () {

        var checkedNum = $('input[name="subcategory"]:checked').length;


        if (!checkedNum) {
            iziToast.warning({
                timeout: 1000,
                imageWidth: 150,
                position: 'center',
                title: 'Warning',
                message: 'Please Select Sub Categories'
            });
            return false;
        } else {

            $("#divAddedItems").show();
            $.each($("input[name='subcategory']:checked"), function () {

                //alert($(this).val());
                var row = "<tr class='active' style='font-size=5px;height:3px;color:black;'>" +
 "<td style='height:5px;' class='text-center'>" + $("#hdbrandId").val() + "</td>" +
"<td style='height:5px;' class='text-center'>" + $('#txtBrandCategory').val() + "</td>" +
 "<td style='height:5px;' class='text-center'>" + $(this).val() + "</td>" +
 "<td style='height:5px;' class='text-center'>" + $(this).next("span").text() + "</td>" +
"<td style='height:3px;width:20px;' class='text-center'><input type='number' min='0' style='width:40px;'class='quantity' name='quantity' value='1'></td>" +
    "<td><button type='button' class='btn btn-danger remove'>remove</button></td>" +
                             "</tr>";


                $('#tblAddedItems tbody').append(row);

            });
            //$('#btnClear').show();

            $('input[name="subcategory"]').prop('checked', false);
        }


    });
    
   
    $("body").on("click", ".remove", function () {

        $(this).closest("tr").remove();
    
    });


    $("#btnSave").click(function () {
        var rowCount = $('#tblAddedItems >tbody >tr').length;
        
        if (rowCount < 1) {
            iziToast.warning({
                timeout: 2000,
                imageWidth: 150,
                position: 'center',
                title: 'warning',
                message: 'There should be 1 OR More Items In table'
            });
            return false;

        } else {
            
            var newBrandOutlet = [];
            $('#tblAddedItems  tbody').find("tr").each(function (row, tr) {

                newBrandOutlet.push({
                    RetailerId: $("#hdbrandId").val(),
                    RetailerName: $('#txtRetailerName').val(),
                    RetailerPhone: $("#txtRetailerPhone").val(),
                    RetailerAddress:$("#txtRetailerAddress").val(),       
                    BrandCategoryId: $(tr).find('td:eq(0)').text(),
                    BrandCategoryName: $(tr).find('td:eq(1)').text(),
                    BrandSubCategoryId: $(tr).find('td:eq(2)').text(),
                    BrandSubCategoryName: $(tr).find('td:eq(3)').text(),
                    Quantity: $(tr).find('input[name="quantity"]').val(),
                    Type:"NEW"
                });

            });
            
            if (newBrandOutlet.length == rowCount) {
                
                $.ajax({
                    url: ' @Url.Action("InsertNewBrandOutletInfo", "BrandOutlet")',
                    type: 'Post',
                    data: JSON.stringify({ newBrandOutlet: newBrandOutlet }),
                    dataType: 'json',
                    async: false,
                    cache: false,
                    contentType: 'application/json',
                    success: function (result) {

                        if (result.IsSuccess) {
                            iziToast.success({
                                timeout: 2000,
                                imageWidth: 150,
                                position: 'center',
                                title: 'Success',
                                message: 'Created Successfully'
                            });
                            //AllClear();
                            $("#hdretailerId").val('');
                            $("#hdbrandId").val('');
                            $('#tblAddedItems tbody').empty();
                            $("#divAddedItems").hide();
                            newBrandOutlet = [];
                            $('#divSubCategory').empty();
                            $("#txtRetailerAddress").val('');
                            $("#txtRetailerPhone").val('');
                            $("#hdretailerId").val('');
                            return true;

                        }
                        else if (result.Id == "0") {
                            window.location = '@Url.Action("LogOut", "Account")';

                        }


                        else {
                            //$('#img').hide();
                            iziToast.error({
                                timeout: 2000,
                                imageWidth: 150,
                                position: 'center',
                                title: 'Error',
                                message: result.Message
                            });


                        }

                    },

                    error: function (result, textStatus, jqXHR) {
                        iziToast.error({
                            timeout: 2000,
                            imageWidth: 150,
                            position: 'center',
                            title: 'Error',
                            message: result.Message
                        });

                        //return false;
                    }
                });


                 }



        }


    });
</script>
